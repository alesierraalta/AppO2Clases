{% extends 'base.html' %}

{% block title %}Resultados Informe Mensual - Sistema de Gestión de Clases{% endblock %}

{% block styles %}
<style media="print">
    @page {
        size: portrait;
    }
    nav, .btn, footer, .no-print, #btn-back-to-top {
        display: none !important;
    }
    .card {
        break-inside: avoid;
        border: 1px solid #dee2e6 !important;
        box-shadow: none !important;
    }
    .collapse {
        display: block !important;
    }
    table {
        width: 100% !important;
    }
    .container-fluid {
        width: 100% !important;
        max-width: 100% !important;
        padding: 0 !important;
    }
    body {
        font-size: 12pt;
    }
    .badge {
        border: 1px solid #333 !important;
    }
}
</style>

<style>
    #btn-back-to-top {
        display: none;
        transition: all 0.2s ease;
    }
    .report-nav-pills .nav-link {
        color: #6c757d;
    }
    .report-nav-pills .nav-link.active {
        background-color: #0d6efd;
        color: white;
    }
    .table-hover tbody tr:hover {
        background-color: rgba(13, 110, 253, 0.05);
    }
    html {
        scroll-behavior: smooth;
    }
    .badge.fs-6 {
        font-size: 0.9rem !important;
    }
    
    /* Estilos para los tipos de clase */
    .bg-move {
        background-color: #28a745 !important;
    }
    .bg-ride {
        background-color: #007bff !important;
    }
    .bg-box {
        background-color: #dc3545 !important;
    }
    
    /* Estilos para la sección de clases no registradas */
    #clases-no-registradas .badge {
        font-size: 0.85rem;
        padding: 0.4em 0.8em;
    }
    
    .table-warning {
        --bs-table-bg: rgba(255, 193, 7, 0.15);
    }
    
    tr.table-warning:hover {
        --bs-table-hover-bg: rgba(255, 193, 7, 0.25);
    }
    
    /* Estilos para los filtros de profesor */
    .filter-tipo-clase {
        transition: all 0.2s ease;
        border-width: 1px;
        font-weight: 500;
    }
    .filter-tipo-clase:hover {
        transform: translateY(-2px);
    }
    .filter-tipo-clase.active {
        border-width: 2px;
        transform: translateY(-2px);
        box-shadow: 0 .25rem .75rem rgba(0, 0, 0, .15) !important;
    }
    #search-profesor:focus {
        box-shadow: none;
        border-color: var(--o2-input-border);
    }
    #search-profesor::placeholder {
        color: #adb5bd;
        font-style: italic;
    }
    .input-group-lg .form-control {
        font-size: 0.95rem;
    }
    #no-results-message {
        color: var(--o2-text-color);
        background-color: rgba(var(--bs-secondary-rgb), 0.05);
    }
    #clear-search {
        cursor: pointer;
        color: var(--o2-text-color);
    }
    #clear-search:hover {
        color: #dc3545;
    }
    /* Animaciones para filtrado */
    .profesor-row {
        transition: all 0.3s ease;
    }
    .table-hover tbody tr.profesor-row:hover {
        background-color: rgba(13, 110, 253, 0.08);
    }
    .fadeIn {
        animation: fadeIn 0.5s;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Animaciones para despliegue de detalles */
    .slide-down {
        animation: slideDown 0.25s ease-out forwards;
        transform-origin: top;
        overflow: hidden;
    }
    .slide-up {
        animation: slideUp 0.2s ease-in forwards;
        transform-origin: top;
        overflow: hidden;
    }
    @keyframes slideDown {
        from { 
            opacity: 0.8;
            max-height: 0;
            transform: scaleY(0.97);
        }
        to { 
            opacity: 1;
            max-height: 2000px;
            transform: scaleY(1);
        }
    }
    @keyframes slideUp {
        from { 
            opacity: 1;
            max-height: 2000px;
            transform: scaleY(1);
        }
        to { 
            opacity: 0.8;
            max-height: 0;
            transform: scaleY(0.97);
        }
    }

    .toggle-clases {
        transition: transform 0.15s ease, background-color 0.15s;
    }
    .toggle-clases:hover {
        transform: scale(1.12);
        background-color: #f8f9fa;
    }
    .toggle-clases:active {
        transform: scale(0.95);
    }
    .toggle-clases i {
        transition: transform 0.2s ease;
    }
    .toggle-clases i.fa-minus {
        transform: rotate(180deg) scale(0.8);
    }

    /* Contenedor de detalles */
    .detalles-container {
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        border-top: 1px solid rgba(0,0,0,0.06);
        transition: all 0.25s ease;
    }

    /* Tarjetas y tablas */
    .card {
        background-color: var(--o2-card-bg);
        border-color: var(--o2-border-color);
    }
    .card-header {
        background-color: var(--o2-card-bg);
        border-color: var(--o2-border-color);
    }
    .table {
        color: var(--o2-text-color);
        border-color: var(--o2-border-color);
    }
    .table-light {
        --bs-table-bg: rgba(var(--bs-light-rgb), 0.1);
    }
    .table-hover tbody tr:hover {
        background-color: var(--o2-table-hover-bg);
    }
    .badge {
        border: none !important;
    }
</style>

<!-- Dark mode specific styles -->
<style>
    /* Dark mode specific overrides */
    [data-bs-theme="dark"] .bg-light {
        background-color: #121212 !important;
    }
    [data-bs-theme="dark"] .bg-white {
        background-color: #1e1e1e !important;
    }
    [data-bs-theme="dark"] .border-top {
        border-color: rgba(255,255,255,0.15) !important;
    }
    [data-bs-theme="dark"] .text-dark {
        color: #ffffff !important;
    }
    [data-bs-theme="dark"] .text-muted {
        color: rgba(255,255,255,0.7) !important;
    }
    [data-bs-theme="dark"] .input-group-text {
        background-color: #2c2c2c;
        border-color: #444444;
    }
    [data-bs-theme="dark"] .card-header.bg-white {
        background-color: #1e1e1e !important;
    }
    [data-bs-theme="dark"] .table-light {
        --bs-table-bg: rgba(255,255,255,0.05);
        color: #ffffff;
    }
    [data-bs-theme="dark"] .btn-outline-secondary {
        color: #ffffff;
        border-color: #555555;
    }
    [data-bs-theme="dark"] .btn-light {
        background-color: #2c2c2c;
        border-color: #444444;
        color: #ffffff;
    }
    [data-bs-theme="dark"] .detalles-container {
        background-color: #1e1e1e !important;
        border-color: #444444 !important;
    }
    [data-bs-theme="dark"] .bg-dark {
        background-color: #121212 !important;
    }
    [data-bs-theme="dark"] .table-primary {
        --bs-table-bg: rgba(13, 110, 253, 0.2);
        color: #ffffff;
    }
    [data-bs-theme="dark"] .table-warning {
        --bs-table-bg: rgba(255, 193, 7, 0.2);
        color: #ffffff;
    }
    [data-bs-theme="dark"] .toggle-clases:hover {
        background-color: #2c2c2c;
    }
    [data-bs-theme="dark"] .card-footer.bg-white {
        background-color: #1e1e1e !important;
    }
    [data-bs-theme="dark"] .alert-info {
        background-color: rgba(13, 202, 240, 0.15);
        color: #ffffff;
    }
    [data-bs-theme="dark"] .alert-warning {
        background-color: rgba(255, 193, 7, 0.15);
        color: #ffffff;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header con acciones principales -->
    <div class="card bg-light mb-4 shadow-sm">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h2 mb-0 text-primary">
                        <i class="fas fa-file-invoice-dollar me-2"></i> Informe Mensual
                    </h1>
                    <p class="lead text-muted mb-0">{{ nombre_mes }} {{ anio }}</p>
                </div>
                <div class="btn-group">
                    <button class="btn btn-outline-success" onclick="exportToExcel()">
                        <i class="fas fa-file-excel me-1"></i> Exportar a Excel
                    </button>
                    <button class="btn btn-outline-primary" onclick="window.print()">
                        <i class="fas fa-print me-1"></i> Imprimir
                    </button>
                    <a href="{{ url_for('informe_mensual') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-sync me-1"></i> Nuevo informe
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Guía de navegación del informe -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body py-2">
                    <ul class="nav nav-pills report-nav-pills nav-fill">
                        <li class="nav-item">
                            <a class="nav-link active" href="#resumen">
                                <i class="fas fa-tachometer-alt me-1"></i> Resumen general
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#profesores">
                                <i class="fas fa-users me-1"></i> Profesores
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#clases">
                                <i class="fas fa-clipboard-list me-1"></i> Clases
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#graficos">
                                <i class="fas fa-chart-pie me-1"></i> Gráficos
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    {% if resumen_profesores %}
    <!-- Cálculos para resumen general -->
    {% set total_clases = namespace(value=0) %}
    {% set total_alumnos = namespace(value=0) %}
    {% set total_retrasos = namespace(value=0) %}
    {% set total_pagos = namespace(value=0) %}
    
    {% for profesor_id, datos in resumen_profesores.items() %}
        {% set total_clases.value = total_clases.value + datos.total_clases %}
        {% set total_alumnos.value = total_alumnos.value + datos.total_alumnos %}
        {% set total_retrasos.value = total_retrasos.value + datos.total_retrasos %}
        {% set total_pagos.value = total_pagos.value + datos.pago_total %}
    {% endfor %}

    <!-- Resumen general en tarjetas -->
    <div id="resumen" class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h2 class="h5 mb-0"><i class="fas fa-tachometer-alt me-2"></i> Resumen General</h2>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card border-0 shadow-sm h-100 text-center">
                                <div class="card-body">
                                    <div class="display-4 text-primary mb-2">
                                        <i class="fas fa-calendar-check"></i>
                                    </div>
                                    <h1 class="display-5 fw-bold mb-0">{{ total_clases.value }}</h1>
                                    <p class="mb-0 text-muted">Clases impartidas</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-0 shadow-sm h-100 text-center">
                                <div class="card-body">
                                    <div class="display-4 {% if total_retrasos.value > 0 %}text-warning{% else %}text-info{% endif %} mb-2">
                                        <i class="fas fa-stopwatch"></i>
                                    </div>
                                    <h1 class="display-5 fw-bold mb-0">{{ total_retrasos.value }}</h1>
                                    <p class="mb-0 text-muted">
                                        Clases con retraso
                                        {% if total_retrasos.value > 0 and total_clases.value > 0 %}
                                            <span class="badge bg-warning text-dark ms-1">{{ (total_retrasos.value / total_clases.value * 100)|round(1) }}%</span>
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-0 shadow-sm h-100 text-center">
                                <div class="card-body">
                                    <div class="display-4 text-danger mb-2">
                                        <i class="fas fa-money-bill-wave"></i>
                                    </div>
                                    <h1 class="display-5 fw-bold mb-0">${{ total_pagos.value|round(2) }}</h1>
                                    <p class="mb-0 text-muted">Total a pagar</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Resumen por profesor -->
    <div id="profesores" class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center bg-white">
                    <h2 class="h5 mb-0"><i class="fas fa-users me-2"></i> Resumen por Profesor</h2>
                    <button class="btn btn-sm btn-light" type="button" data-bs-toggle="collapse" data-bs-target="#resumenProfesores" aria-expanded="true">
                        <i class="fas fa-angle-up"></i>
                    </button>
                </div>
                <!-- Filtros para profesores -->
                <div class="card-body pb-0">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="input-group input-group-lg shadow-sm">
                                <span class="input-group-text bg-white border-end-0">
                                    <i class="fas fa-search text-primary"></i>
                                </span>
                                <input type="text" id="search-profesor" class="form-control border-start-0 py-2" 
                                    placeholder="Buscar profesor..." aria-label="Buscar profesor">
                                <button class="btn btn-outline-secondary border-start-0 bg-white" type="button" id="clear-search" style="display: none;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex flex-wrap gap-2 justify-content-md-end">
                                <button class="btn btn-outline-secondary filter-tipo-clase shadow-sm" data-tipo="TODOS">
                                    <i class="fas fa-globe-americas me-1"></i> Todos
                                </button>
                                <button class="btn btn-outline-success filter-tipo-clase shadow-sm" data-tipo="MOVE">
                                    <i class="fas fa-running me-1"></i> MOVE
                                </button>
                                <button class="btn btn-outline-primary filter-tipo-clase shadow-sm" data-tipo="RIDE">
                                    <i class="fas fa-bicycle me-1"></i> RIDE
                                </button>
                                <button class="btn btn-outline-danger filter-tipo-clase shadow-sm" data-tipo="BOX">
                                    <i class="fas fa-dumbbell me-1"></i> BOX
                                </button>
                                <button class="btn btn-outline-dark filter-tipo-clase shadow-sm" data-tipo="OTRO">
                                    <i class="fas fa-ellipsis-h me-1"></i> OTRO
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- Contador de resultados -->
                    <div class="d-flex justify-content-between align-items-center mt-3 text-muted small">
                        <div id="filter-results-count">Mostrando todos los profesores</div>
                        <div>
                            <i class="fas fa-info-circle me-1"></i> Selecciona un filtro o busca por nombre
                        </div>
                    </div>
                </div>
                <div class="collapse show" id="resumenProfesores">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr class="table-light">
                                        <th scope="col" class="text-center" style="width: 40px;"></th>
                                        <th scope="col">Profesor</th>
                                        <th scope="col" class="text-center">Total Clases</th>
                                        <th scope="col" class="text-center">Promedio Alumnos/Clase</th>
                                        <th scope="col" class="text-center">Clases con Retraso</th>
                                        <th scope="col" class="text-center">Tarifa por Clase</th>
                                        <th scope="col" class="text-center">Pago Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for profesor_id, datos in resumen_profesores.items() %}
                                    <tr class="profesor-row" 
                                        data-profesor-nombre="{{ datos.profesor.nombre|lower }} {{ datos.profesor.apellido|lower }}"
                                        data-move="{{ datos.clases_por_tipo.MOVE }}"
                                        data-ride="{{ datos.clases_por_tipo.RIDE }}"
                                        data-box="{{ datos.clases_por_tipo.BOX }}"
                                        data-otro="{{ datos.clases_por_tipo.OTRO }}">
                                        <td class="text-center align-middle">
                                            <button class="btn btn-sm btn-outline-secondary toggle-clases" data-profesor-id="{{ profesor_id }}">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="avatar rounded-circle text-center me-2 p-1" style="width: 40px; height: 40px; background-color: rgba(54, 162, 235, 0.2);">
                                                    <i class="fas fa-user text-primary"></i>
                                                </div>
                                                <div>
                                                    <div class="fw-bold">{{ datos.profesor.nombre }} {{ datos.profesor.apellido }}</div>
                                                    <small class="text-muted">ID: {{ datos.profesor.id }}</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-center align-middle">
                                            <span class="badge rounded-pill bg-primary">{{ datos.total_clases }}</span>
                                        </td>
                                        <td class="text-center align-middle">
                                            {% if datos.total_clases > 0 %}
                                                {{ (datos.total_alumnos / datos.total_clases)|round(1) }}
                                                <div class="progress mt-1" style="height: 5px;">
                                                    <div class="progress-bar bg-info" role="progressbar" style="width: {{ (datos.total_alumnos / datos.total_clases / 20 * 100)|round }}%;" title="Promedio respecto a capacidad típica"></div>
                                                </div>
                                            {% else %}
                                                0
                                            {% endif %}
                                        </td>
                                        <td class="text-center align-middle">
                                            {% if datos.total_retrasos > 0 %}
                                                <div class="position-relative">
                                                    <span class="badge rounded-pill bg-warning text-dark">{{ datos.total_retrasos }}</span>
                                                    <small class="d-block mt-1">{{ (datos.total_retrasos / datos.total_clases * 100)|round(1) }}%</small>
                                                </div>
                                            {% else %}
                                                <span class="badge rounded-pill bg-success"><i class="fas fa-check"></i> 0</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-center align-middle">${{ datos.profesor.tarifa_por_clase|round(2) }}</td>
                                        <td class="text-center align-middle">
                                            <span class="badge rounded-pill bg-danger fs-6">${{ datos.pago_total|round(2) }}</span>
                                        </td>
                                    </tr>
                                    <tr class="clases-detalle" id="clases-profesor-{{ profesor_id }}" style="display: none;">
                                        <td colspan="7" class="p-0">
                                            <div class="bg-light p-3 shadow-sm border-top detalles-container">
                                                <h6 class="mb-3 border-bottom pb-2 d-flex justify-content-between align-items-center">
                                                    <span>
                                                        <i class="fas fa-list-ul me-2 text-primary"></i> 
                                                        Clases de {{ datos.profesor.nombre }} {{ datos.profesor.apellido }}
                                                    </span>
                                                    <span class="badge bg-secondary">{{ clases_realizadas|selectattr('profesor.id', 'equalto', datos.profesor.id)|list|length }} clases</span>
                                                </h6>
                                                {% set clases_profesor = [] %}
                                                {% for clase in clases_realizadas if clase.profesor.id == datos.profesor.id %}
                                                    {% set _ = clases_profesor.append(clase) %}
                                                {% endfor %}
                                                
                                                {% if clases_profesor %}
                                                <div class="table-responsive rounded" style="transition: all 0.3s ease">
                                                    <table class="table table-sm table-hover mb-0 border">
                                                        <thead>
                                                            <tr class="table-primary">
                                                                <th>Fecha</th>
                                                                <th>Clase</th>
                                                                <th>Horario</th>
                                                                <th>Estado</th>
                                                                <th>Hora de llegada</th>
                                                                <th>Puntualidad</th>
                                                                <th class="text-center">Alumnos</th>
                                                                <th class="text-center">Pago</th>
                                                                <th>Observaciones</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for clase in clases_profesor|sort(attribute='fecha') %}
                                                            <tr>
                                                                <td>{{ clase.fecha.strftime('%d/%m/%Y') }}</td>
                                                                <td>{{ clase.horario.nombre }}</td>
                                                                <td>
                                                                {% if clase.horario.hora_inicio %}
                                                                    {{ clase.horario.hora_inicio.strftime('%H:%M') }} - {{ clase.horario.hora_fin_str }}
                                                                {% else %}
                                                                    --:-- - --:--
                                                                {% endif %}
                                                                </td>
                                                                <td>
                                                                    {% if clase.profesor_suplente %}
                                                                        <span class="badge bg-info">Impartida por suplente</span>
                                                                        <div class="small text-muted mt-1">{{ clase.profesor_suplente.nombre }} {{ clase.profesor_suplente.apellido }}</div>
                                                                    {% elif clase.ausencia_profesor or (clase.observaciones and 'CLASE CANCELADA' in clase.observaciones) or not clase.hora_llegada_profesor %}
                                                                        <div class="d-flex flex-column align-items-center">
                                                                            <span class="badge bg-danger fs-6 mb-1">CLASE CANCELADA</span>
                                                                            {% if clase.motivo_ausencia %}
                                                                                <small class="text-danger d-block">{{ clase.motivo_ausencia }}</small>
                                                                            {% endif %}
                                                                        </div>
                                                                    {% else %}
                                                                        <span class="badge bg-success">Impartida por titular</span>
                                                                    {% endif %}
                                                                </td>
                                                                <td class="align-middle">
                                                                    {% if clase.hora_llegada_str %}
                                                                        {{ clase.hora_llegada_str }}
                                                                    {% elif clase.profesor_suplente %}
                                                                        <span class="text-muted fst-italic">Suplente</span>
                                                                    {% elif clase.ausencia_profesor %}
                                                                        <span class="text-muted fst-italic">No asistió</span>
                                                                    {% else %}
                                                                        <span class="text-danger fw-bold">SIN REGISTRO DE ASISTENCIA</span>
                                                                    {% endif %}
                                                                </td>
                                                                <td class="align-middle">
                                                                    {% if clase.hora_llegada_profesor %}
                                                                        <span class="badge rounded-pill {% if clase.puntualidad == 'Puntual' %}bg-success{% elif clase.puntualidad == 'Retraso leve' %}bg-warning text-dark{% else %}bg-danger{% endif %}">
                                                                            {{ clase.puntualidad }}
                                                                        </span>
                                                                    {% elif clase.profesor_suplente %}
                                                                        <span class="badge rounded-pill bg-secondary">Suplente</span>
                                                                    {% elif clase.ausencia_profesor %}
                                                                        <span class="badge rounded-pill bg-danger">Ausente</span>
                                                                    {% else %}
                                                                        <span class="badge rounded-pill bg-secondary">N/A</span>
                                                                    {% endif %}
                                                                </td>
                                                                <td class="text-center align-middle">
                                                                    <div class="d-flex align-items-center justify-content-center">
                                                                        <span class="badge rounded-pill bg-info text-dark">{{ clase.cantidad_alumnos }}</span>
                                                                    </div>
                                                                    {% if clase.hora_llegada_profesor and clase.cantidad_alumnos == 0 %}
                                                                        <div class="small text-danger text-center mt-1">Tarifa reducida 50%</div>
                                                                    {% endif %}
                                                                </td>
                                                                <td class="text-center align-middle">
                                                                    <span class="badge bg-success">${{ clase.pago_calculado|round(2) }}</span>
                                                                </td>
                                                                <td>
                                                                    {% if clase.observaciones %}
                                                                        <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="popover" data-bs-placement="left" title="Observaciones" data-bs-content="{{ clase.observaciones }}">
                                                                            <i class="fas fa-comment-dots"></i>
                                                                        </button>
                                                                    {% endif %}
                                                                </td>
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                                {% else %}
                                                <div class="alert alert-info mb-0">
                                                    No hay clases registradas para este profesor en el período seleccionado.
                                                </div>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sección: Clases detalladas -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white" id="clases">
                    <h3 class="mb-0">
                        <i class="fas fa-clipboard-list me-2"></i> Detalle de Clases 
                        <span class="badge bg-light text-dark ms-2">{{ clases_realizadas|length }}</span>
                    </h3>
                </div>
                <div class="card-body">
                    
                    <!-- Filtros para la tabla -->
                    <div class="mb-3">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" id="searchInput" class="form-control" placeholder="Buscar...">
                        </div>
                        <small class="text-muted">Busque por profesor, fecha o cualquier otro criterio</small>
                    </div>
                    
                    <!-- Tabla de clases -->
                    <div class="table-responsive">
                        {% if clases_realizadas %}
                        <table class="table table-sm table-hover mb-0" id="tableclases">
                            <thead>
                                <tr class="table-light">
                                    <th scope="col">Fecha</th>
                                    <th scope="col">Clase</th>
                                    <th scope="col">Horario</th>
                                    <th scope="col">Profesor</th>
                                    <th scope="col">Estado</th>
                                    <th scope="col">Hora de llegada</th>
                                    <th scope="col">Puntualidad</th>
                                    <th scope="col" class="text-center">Alumnos</th>
                                    <th scope="col" class="text-center">Pago</th>
                                    <th scope="col">Observaciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for clase in clases_realizadas %}
                                <tr>
                                    <td class="align-middle">{{ clase.fecha.strftime('%d/%m/%Y') }}</td>
                                    <td class="align-middle fw-medium">{{ clase.horario.nombre }}</td>
                                    <td class="align-middle">
                                    {% if clase.horario.hora_inicio %}
                                        {{ clase.horario.hora_inicio.strftime('%H:%M') }} - {{ clase.horario.hora_fin_str }}
                                    {% else %}
                                        --:-- - --:--
                                    {% endif %}
                                    </td>
                                    <td class="align-middle">
                                        {{ clase.profesor.nombre }} {{ clase.profesor.apellido }}
                                        {% if clase.profesor_suplente %}
                                            <div class="badge bg-info small">Suplido por: {{ clase.profesor_suplente.nombre }} {{ clase.profesor_suplente.apellido }}</div>
                                        {% endif %}
                                    </td>
                                    <td class="align-middle">
                                        {% if clase.profesor_suplente %}
                                            <span class="badge bg-info">Impartida por suplente</span>
                                            <div class="small text-muted mt-1">{{ clase.profesor_suplente.nombre }} {{ clase.profesor_suplente.apellido }}</div>
                                        {% elif clase.ausencia_profesor or (clase.observaciones and 'CLASE CANCELADA' in clase.observaciones) or not clase.hora_llegada_profesor %}
                                            <div class="d-flex flex-column align-items-center">
                                                <span class="badge bg-danger fs-6 mb-1">CLASE CANCELADA</span>
                                                {% if clase.motivo_ausencia %}
                                                    <small class="text-danger d-block">{{ clase.motivo_ausencia }}</small>
                                                {% endif %}
                                            </div>
                                        {% else %}
                                            <span class="badge bg-success">Normal</span>
                                        {% endif %}
                                    </td>
                                    <td class="align-middle">
                                        {% if clase.hora_llegada_str %}
                                            {{ clase.hora_llegada_str }}
                                        {% elif clase.profesor_suplente %}
                                            <span class="text-muted fst-italic">Suplente</span>
                                        {% elif clase.ausencia_profesor %}
                                            <span class="text-danger fw-bold">SIN REGISTRO DE ASISTENCIA</span>
                                        {% else %}
                                            <span class="text-danger fw-bold">SIN REGISTRO DE ASISTENCIA</span>
                                        {% endif %}
                                    </td>
                                    <td class="align-middle">
                                        {% if clase.hora_llegada_profesor %}
                                            <span class="badge rounded-pill {% if clase.puntualidad == 'Puntual' %}bg-success{% elif clase.puntualidad == 'Retraso leve' %}bg-warning text-dark{% else %}bg-danger{% endif %}">
                                                {{ clase.puntualidad }}
                                            </span>
                                        {% elif clase.profesor_suplente %}
                                            <span class="badge rounded-pill bg-secondary">Suplente</span>
                                        {% elif clase.ausencia_profesor %}
                                            <span class="badge rounded-pill bg-danger">Ausente</span>
                                        {% else %}
                                            <span class="badge rounded-pill bg-secondary">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center align-middle">
                                        <div class="d-flex align-items-center justify-content-center">
                                            <span class="badge rounded-pill bg-info text-dark">{{ clase.cantidad_alumnos }}</span>
                                        </div>
                                        {% if clase.hora_llegada_profesor and clase.cantidad_alumnos == 0 %}
                                            <div class="small text-danger text-center mt-1">Tarifa reducida 50%</div>
                                        {% endif %}
                                    </td>
                                    <td class="text-center align-middle">
                                        <span class="badge bg-success">${{ clase.pago_calculado|round(2) }}</span>
                                    </td>
                                    <td class="align-middle">
                                        {% if clase.observaciones %}
                                            <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="popover" data-bs-placement="left" title="Observaciones" data-bs-content="{{ clase.observaciones }}">
                                                <i class="fas fa-comment-dots"></i>
                                            </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        <div class="card-footer bg-white text-muted d-flex justify-content-between align-items-center pt-2 pb-2">
                            <div>
                                <small>Mostrando {{ clases_realizadas|length }} clases</small>
                            </div>
                            <div>
                                <span class="badge bg-success me-1">Normal</span>
                                <span class="badge bg-info me-1">Suplente</span>
                                <span class="badge bg-danger me-1">Cancelada</span>
                                <span class="badge rounded-pill bg-success me-1">Puntual</span>
                                <span class="badge rounded-pill bg-warning text-dark me-1">Retraso leve</span>
                                <span class="badge rounded-pill bg-danger">Retraso significativo</span>
                            </div>
                        </div>
                        {% else %}
                        <div class="alert alert-info m-3">
                            <i class="fas fa-info-circle me-2"></i> No hay clases registradas para este período.
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- NUEVA SECCIÓN: Clases no registradas -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-warning text-dark" id="clases-no-registradas">
                    <h3 class="mb-0 d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-exclamation-triangle me-2"></i> Clases No Registradas
                            <span class="badge bg-dark text-white ms-2">{{ conteo_no_registradas.total }}</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="badge bg-move text-white me-2">MOVE: {{ conteo_no_registradas.MOVE }}</span>
                            <span class="badge bg-ride text-white me-2">RIDE: {{ conteo_no_registradas.RIDE }}</span>
                            <span class="badge bg-box text-white me-2">BOX: {{ conteo_no_registradas.BOX }}</span>
                            <span class="badge bg-secondary text-white">OTRO: {{ conteo_no_registradas.OTRO }}</span>
                        </div>
                    </h3>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning mb-3">
                        <i class="fas fa-info-circle me-2"></i> Las siguientes clases estaban programadas pero no tienen registros de asistencia en el sistema. Puede que las clases se hayan realizado pero no se hayan registrado, o que se hayan cancelado sin notificación.
                    </div>
                    
                    <!-- Filtros y acciones para clases no registradas -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="input-group" style="max-width: 400px;">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" id="searchNoRegistradas" class="form-control" placeholder="Buscar clases no registradas...">
                        </div>
                        
                        <div>
                            <button id="btnSeleccionarTodasNoRegistradas" class="btn btn-outline-secondary me-2">
                                <i class="fas fa-check-square me-1"></i> Seleccionar todas
                            </button>
                            <button id="btnRegistrarSeleccionadas" class="btn btn-primary" style="display:none">
                                <i class="fas fa-clipboard-check me-1"></i> Registrar <span id="contadorSeleccionadas">0</span> clases
                            </button>
                        </div>
                    </div>
                    
                    <!-- Tabla de clases no registradas -->
                    <div class="table-responsive">
                        {% if clases_no_registradas %}
                        <form id="formRegistroMasivo" action="{{ url_for('registrar_clases_no_registradas') }}" method="POST">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <table class="table table-sm table-hover mb-0" id="tablaNoRegistradas">
                                <thead>
                                    <tr class="table-light">
                                        <th scope="col" style="width: 40px;">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="checkTodas">
                                            </div>
                                        </th>
                                        <th scope="col">Fecha</th>
                                        <th scope="col">Clase</th>
                                        <th scope="col">Tipo</th>
                                        <th scope="col">Horario</th>
                                        <th scope="col">Profesor</th>
                                        <th scope="col">Acción</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for clase in clases_no_registradas %}
                                    <tr class="table-warning">
                                        <td>
                                            <div class="form-check">
                                                <input class="form-check-input checkbox-clase" type="checkbox" name="clases_ids[]" value="{{ clase.fecha.strftime('%Y-%m-%d') }}|{{ clase.horario.id }}">
                                            </div>
                                        </td>
                                        <td class="align-middle">{{ clase.fecha.strftime('%d/%m/%Y') }}</td>
                                        <td class="align-middle fw-medium">{{ clase.horario.nombre }}</td>
                                        <td class="align-middle">
                                            {% if clase.tipo_clase == 'MOVE' %}
                                            <span class="badge bg-move">MOVE</span>
                                            {% elif clase.tipo_clase == 'RIDE' %}
                                            <span class="badge bg-ride">RIDE</span>
                                            {% elif clase.tipo_clase == 'BOX' %}
                                            <span class="badge bg-box">BOX</span>
                                            {% else %}
                                            <span class="badge bg-secondary">OTRO</span>
                                            {% endif %}
                                        </td>
                                        <td class="align-middle">
                                            {% if clase.horario.hora_inicio %}
                                                {% if clase.horario.hora_inicio is string %}
                                                    {{ clase.horario.hora_inicio }} - {{ clase.horario.hora_fin_str }}
                                                {% else %}
                                                    {{ clase.horario.hora_inicio.strftime('%H:%M') }} - {{ clase.horario.hora_fin_str }}
                                                {% endif %}
                                            {% else %}
                                                --:-- - --:--
                                            {% endif %}
                                        </td>
                                        <td class="align-middle">
                                            {{ clase.profesor.nombre }} {{ clase.profesor.apellido }}
                                        </td>
                                        <td class="align-middle">
                                            <a href="{{ url_for('registrar_asistencia_fecha', fecha=clase.fecha.strftime('%Y-%m-%d'), horario_id=clase.horario.id) }}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-clipboard-check me-1"></i> Registrar
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </form>
                        {% else %}
                        <div class="alert alert-success m-3">
                            <i class="fas fa-check-circle me-2"></i> Todas las clases programadas para este período han sido registradas correctamente.
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de confirmación para registro masivo -->
    <div class="modal fade" id="modalConfirmacionRegistro" tabindex="-1" aria-labelledby="modalConfirmacionRegistroLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalConfirmacionRegistroLabel">Confirmar registro de clases</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Está a punto de registrar <strong id="numClasesARegistrar">0</strong> clases no registradas.</p>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i> Estas clases se crearán con <strong>0 alumnos</strong> y se marcarán como registradas automáticamente. Puede editar los detalles más tarde.
                    </div>
                    <p>¿Está seguro de continuar?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btnConfirmarRegistro">Registrar clases</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sección: Gráficos -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white" id="graficos">
                    <h3 class="mb-0">
                        <i class="fas fa-chart-pie me-2"></i> Análisis Visual 
                    </h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-body">
                                    <canvas id="classTypeChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-body">
                                    <canvas id="studentTypeChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="row">
        <div class="col-12">
            <div class="alert alert-info shadow-sm">
                <div class="d-flex">
                    <div class="me-3">
                        <i class="fas fa-info-circle fa-3x text-info"></i>
                    </div>
                    <div>
                        <h4 class="alert-heading">No hay datos disponibles</h4>
                        <p>No se encontraron datos para mostrar en el informe del mes de {{ nombre_mes }} de {{ anio }}.</p>
                        <hr>
                        <p class="mb-0">Verifica que existan registros de clases para este período o selecciona un mes diferente.</p>
                        <a href="{{ url_for('informe_mensual') }}" class="btn btn-info mt-3">
                            <i class="fas fa-calendar-alt me-1"></i> Seleccionar otro mes
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Botón volver flotante -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 5">
        <a href="#" class="btn btn-primary btn-lg rounded-circle shadow" id="btn-back-to-top">
            <i class="fas fa-arrow-up"></i>
        </a>
    </div>
</div>

<style media="print">
    @page {
        size: portrait;
    }
    nav, .btn, footer, .no-print, #btn-back-to-top {
        display: none !important;
    }
    .card {
        break-inside: avoid;
        border: 1px solid #dee2e6 !important;
        box-shadow: none !important;
    }
    .collapse {
        display: block !important;
    }
    table {
        width: 100% !important;
    }
    .container-fluid {
        width: 100% !important;
        max-width: 100% !important;
        padding: 0 !important;
    }
    body {
        font-size: 12pt;
    }
    .badge {
        border: 1px solid #333 !important;
    }
</style>

<style>
    #btn-back-to-top {
        display: none;
        transition: all 0.2s ease;
    }
    .report-nav-pills .nav-link {
        color: #6c757d;
    }
    .report-nav-pills .nav-link.active {
        background-color: #0d6efd;
        color: white;
    }
    .table-hover tbody tr:hover {
        background-color: rgba(13, 110, 253, 0.05);
    }
    html {
        scroll-behavior: smooth;
    }
    .badge.fs-6 {
        font-size: 0.9rem !important;
    }
    
    /* Estilos para los tipos de clase */
    .bg-move {
        background-color: #28a745 !important;
    }
    .bg-ride {
        background-color: #007bff !important;
    }
    .bg-box {
        background-color: #dc3545 !important;
    }
    
    /* Estilos para la sección de clases no registradas */
    #clases-no-registradas .badge {
        font-size: 0.85rem;
        padding: 0.4em 0.8em;
    }
    
    .table-warning {
        --bs-table-bg: rgba(255, 193, 7, 0.15);
    }
    
    tr.table-warning:hover {
        --bs-table-hover-bg: rgba(255, 193, 7, 0.25);
    }
    
    /* Estilos para los filtros de profesor */
    .filter-tipo-clase {
        transition: all 0.2s ease;
        border-width: 1px;
        font-weight: 500;
    }
    .filter-tipo-clase:hover {
        transform: translateY(-2px);
    }
    .filter-tipo-clase.active {
        border-width: 2px;
        transform: translateY(-2px);
        box-shadow: 0 .25rem .75rem rgba(0, 0, 0, .15) !important;
    }
    #search-profesor:focus {
        box-shadow: none;
        border-color: var(--o2-input-border);
    }
    #search-profesor::placeholder {
        color: #adb5bd;
        font-style: italic;
    }
    .input-group-lg .form-control {
        font-size: 0.95rem;
    }
    #no-results-message {
        color: var(--o2-text-color);
        background-color: rgba(var(--bs-secondary-rgb), 0.05);
    }
    #clear-search {
        cursor: pointer;
        color: var(--o2-text-color);
    }
    #clear-search:hover {
        color: #dc3545;
    }
    /* Animaciones para filtrado */
    .profesor-row {
        transition: all 0.3s ease;
    }
    .table-hover tbody tr.profesor-row:hover {
        background-color: rgba(13, 110, 253, 0.08);
    }
    .fadeIn {
        animation: fadeIn 0.5s;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Animaciones para despliegue de detalles */
    .slide-down {
        animation: slideDown 0.25s ease-out forwards;
        transform-origin: top;
        overflow: hidden;
    }
    .slide-up {
        animation: slideUp 0.2s ease-in forwards;
        transform-origin: top;
        overflow: hidden;
    }
    @keyframes slideDown {
        from { 
            opacity: 0.8;
            max-height: 0;
            transform: scaleY(0.97);
        }
        to { 
            opacity: 1;
            max-height: 2000px;
            transform: scaleY(1);
        }
    }
    @keyframes slideUp {
        from { 
            opacity: 1;
            max-height: 2000px;
            transform: scaleY(1);
        }
        to { 
            opacity: 0.8;
            max-height: 0;
            transform: scaleY(0.97);
        }
    }

    .toggle-clases {
        transition: transform 0.15s ease, background-color 0.15s;
    }
    .toggle-clases:hover {
        transform: scale(1.12);
        background-color: #f8f9fa;
    }
    .toggle-clases:active {
        transform: scale(0.95);
    }
    .toggle-clases i {
        transition: transform 0.2s ease;
    }
    .toggle-clases i.fa-minus {
        transform: rotate(180deg) scale(0.8);
    }

    /* Contenedor de detalles */
    .detalles-container {
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        border-top: 1px solid rgba(0,0,0,0.06);
        transition: all 0.25s ease;
    }
</style>
{% endblock %}

{% block scripts %}
<!-- Asegurar que Bootstrap esté disponible -->
<script>
    // Verificar si bootstrap ya está definido
    if (typeof bootstrap === 'undefined') {
        console.log('Bootstrap no detectado, cargando...');
        // Crear un elemento script para cargar Bootstrap
        var bootstrapScript = document.createElement('script');
        bootstrapScript.src = 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js';
        bootstrapScript.integrity = 'sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz';
        bootstrapScript.crossOrigin = 'anonymous';
        
        // Esperar a que cargue antes de inicializar los componentes de Bootstrap
        bootstrapScript.onload = function() {
            console.log('Bootstrap cargado correctamente');
            // Disparar un evento personalizado para que otro código sepa que bootstrap está listo
            document.dispatchEvent(new Event('bootstrap:loaded'));
        };
        
        document.head.appendChild(bootstrapScript);
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Variables for filtering
        let searchInput = document.getElementById('search-profesor');
        let filterButtons = document.querySelectorAll('.filter-tipo-clase');
        let currentFilter = 'TODOS';
        
        // Set active class for initial "Todos" button
        document.querySelector('.filter-tipo-clase[data-tipo="TODOS"]').classList.add('active');
        
        // Search functionality for professors
        if (searchInput) {
            searchInput.addEventListener('input', filterProfessors);
        }
        
        // Function that applies both search and class type filters
        function filterProfessors() {
            let searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            let rows = document.querySelectorAll('.profesor-row');
            let tableParent = document.querySelector('#resumenProfesores tbody');
            let resultsCount = document.getElementById('filter-results-count');
            let clearSearchBtn = document.getElementById('clear-search');
            
            // Show/hide clear button based on search term
            if (clearSearchBtn) {
                clearSearchBtn.style.display = searchTerm ? 'block' : 'none';
            }
            
            let visibleCount = 0;
            
            rows.forEach(row => {
                let professorName = row.getAttribute('data-profesor-nombre');
                let nameMatches = professorName.includes(searchTerm);
                
                // Check if class type matches current filter
                let typeMatches = currentFilter === 'TODOS';
                
                if (!typeMatches) {
                    let classCount = parseInt(row.getAttribute('data-' + currentFilter.toLowerCase())) || 0;
                    typeMatches = classCount > 0;
                }
                
                // Show row only if both conditions match
                if (nameMatches && typeMatches) {
                    row.style.display = '';
                    // Remove existing animation class if any
                    row.classList.remove('fadeIn');
                    // Force DOM reflow to restart animation
                    void row.offsetWidth;
                    // Add animation class
                    row.classList.add('fadeIn');
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                    row.classList.remove('fadeIn');
                }
                
                // Handle the expanded detail row
                let professorId = row.querySelector('.toggle-clases').getAttribute('data-profesor-id');
                let detailRow = document.getElementById(`clases-profesor-${professorId}`);
                
                if (detailRow) {
                    if (nameMatches && typeMatches) {
                        // Solo mostrar si el ícono del botón tiene la clase fa-minus (detalles expandidos)
                        let isExpanded = row.querySelector('.toggle-clases i').classList.contains('fa-minus');
                        
                        if (isExpanded) {
                            // Si ya estaba expandido, mantenerlo expandido con la animación
                            detailRow.style.display = 'table-row';
                            // Si no tiene la clase slide-down, añadirla para animar
                            if (!detailRow.classList.contains('slide-down')) {
                                detailRow.classList.remove('slide-up');
                                void detailRow.offsetWidth; // Forzar reflow
                                detailRow.classList.add('slide-down');
                            }
                        } else {
                            detailRow.style.display = 'none';
                        }
                    } else {
                        // Si no coincide con el filtro, ocultar sin animación
                        detailRow.style.display = 'none';
                        detailRow.classList.remove('slide-down', 'slide-up');
                    }
                }
            });
            
            // Update results count text
            if (resultsCount) {
                if (visibleCount === 0) {
                    resultsCount.textContent = 'No se encontraron profesores';
                } else if (searchTerm || currentFilter !== 'TODOS') {
                    if (currentFilter !== 'TODOS' && searchTerm) {
                        resultsCount.textContent = `Mostrando ${visibleCount} profesor(es) de tipo ${currentFilter} que coinciden con "${searchTerm}"`;
                    } else if (currentFilter !== 'TODOS') {
                        resultsCount.textContent = `Mostrando ${visibleCount} profesor(es) de tipo ${currentFilter}`;
                    } else if (searchTerm) {
                        resultsCount.textContent = `Mostrando ${visibleCount} profesor(es) que coinciden con "${searchTerm}"`;
                    }
                } else {
                    resultsCount.textContent = 'Mostrando todos los profesores';
                }
            }
            
            // Show message if no results
            let noResultsMsg = document.getElementById('no-results-message');
            if (!noResultsMsg && tableParent) {
                noResultsMsg = document.createElement('tr');
                noResultsMsg.id = 'no-results-message';
                noResultsMsg.innerHTML = '<td colspan="7" class="text-center py-4"><i class="fas fa-exclamation-circle text-muted me-2"></i>No se encontraron profesores que coincidan con los filtros</td>';
                tableParent.appendChild(noResultsMsg);
            }
            
            // Show or hide no results message
            if (noResultsMsg) {
                noResultsMsg.style.display = visibleCount === 0 ? '' : 'none';
            }
        }
        
        // Class type filter functionality
        filterButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Remove active class from all buttons
                filterButtons.forEach(btn => {
                    btn.classList.remove('active');
                    
                    // Reset button styles to outline version
                    if (btn.getAttribute('data-tipo') === 'MOVE') {
                        btn.classList.remove('btn-success');
                        btn.classList.add('btn-outline-success');
                    } else if (btn.getAttribute('data-tipo') === 'RIDE') {
                        btn.classList.remove('btn-primary');
                        btn.classList.add('btn-outline-primary');
                    } else if (btn.getAttribute('data-tipo') === 'BOX') {
                        btn.classList.remove('btn-danger');
                        btn.classList.add('btn-outline-danger');
                    } else if (btn.getAttribute('data-tipo') === 'OTRO') {
                        btn.classList.remove('btn-dark');
                        btn.classList.add('btn-outline-dark');
                    } else { // TODOS
                        btn.classList.remove('btn-secondary');
                        btn.classList.add('btn-outline-secondary');
                    }
                });
                
                // Add active class to clicked button and change color based on type
                button.classList.add('active');
                let tipo = button.getAttribute('data-tipo');
                currentFilter = tipo;
                
                // Add appropriate color class based on class type
                if (tipo === 'MOVE') {
                    button.classList.remove('btn-outline-success');
                    button.classList.add('btn-success');
                } else if (tipo === 'RIDE') {
                    button.classList.remove('btn-outline-primary');
                    button.classList.add('btn-primary');
                } else if (tipo === 'BOX') {
                    button.classList.remove('btn-outline-danger');
                    button.classList.add('btn-danger');
                } else if (tipo === 'OTRO') {
                    button.classList.remove('btn-outline-dark');
                    button.classList.add('btn-dark');
                } else { // TODOS
                    button.classList.remove('btn-outline-secondary');
                    button.classList.add('btn-secondary');
                }
                
                // Apply filters
                filterProfessors();
            });
        });
        
        // Add clear search button functionality
        document.getElementById('clear-search')?.addEventListener('click', function() {
            if (searchInput) {
                searchInput.value = '';
                filterProfessors();
                searchInput.focus();
            }
        });
        
        // Toggle buttons implementation for expandable professor rows
        document.querySelectorAll('.toggle-clases').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault(); // Prevenir comportamiento por defecto
                
                const profesorId = this.getAttribute('data-profesor-id');
                const detailRow = document.getElementById(`clases-profesor-${profesorId}`);
                const icon = this.querySelector('i');
                
                if (detailRow) {
                    // Limpiar clases de animación previas
                    detailRow.classList.remove('slide-down', 'slide-up');
                    
                    if (detailRow.style.display === 'none' || detailRow.style.display === '') {
                        // Cambiar estilo de display antes de animar
                        detailRow.style.display = 'table-row';
                        
                        // Forzar un reflow del DOM para asegurar que la animación se inicie correctamente
                        void detailRow.offsetWidth;
                        
                        // Aplicar animación de despliegue
                        detailRow.classList.add('slide-down');
                        
                        // Cambiar el icono
                        icon.classList.remove('fa-plus');
                        icon.classList.add('fa-minus');
                    } else {
                        // Animar cierre y luego ocultar
                        detailRow.classList.add('slide-up');
                        
                        // Cambiar el icono inmediatamente
                        icon.classList.remove('fa-minus');
                        icon.classList.add('fa-plus');
                        
                        // Esperar a que termine la animación para ocultar la fila
                        setTimeout(() => {
                            detailRow.style.display = 'none';
                        }, 180); // Ligeramente menor que la duración de la animación (0.2s)
                    }
                } else {
                    console.error('No se encontró la fila de detalles:', `clases-profesor-${profesorId}`);
                }
            });
        });
        
        // Back to top button logic
        const btnBackToTop = document.getElementById('btn-back-to-top');
        if (btnBackToTop) {
            window.addEventListener('scroll', function() {
                if (window.scrollY > 300) {
                    btnBackToTop.style.display = 'block';
                } else {
                    btnBackToTop.style.display = 'none';
                }
            });
            
            btnBackToTop.addEventListener('click', function() {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            });
        }
    });
</script>

<!-- Add SheetJS for Excel export -->
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
{% endblock %} 