{% extends 'base.html' %}

{% block title %}Métricas de Profesor - {{ profesor.nombre }} {{ profesor.apellido }}{% endblock %}

{% block head %}
{{ super() }}
<style>
    /* Estilos generales */
    .metrics-card {
        transition: all 0.3s ease;
        height: 100%;
    }
    .metrics-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important;
    }
    .chart-container {
        position: relative;
        margin: 0 auto;
        height: 300px;
        width: 100%;
    }
    .metric-value {
        font-size: 2.5rem;
        font-weight: 700;
    }
    .metric-title {
        font-size: 0.95rem;
        font-weight: 600;
        color: #6c757d;
        margin-bottom: 10px;
    }
    .professor-card {
        border-radius: 10px;
        overflow: hidden;
    }
    .avatar-container {
        width: 96px;
        height: 96px;
        margin: 0 auto;
        border-radius: 50%;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #f0f4f8;
    }
    @media (max-width: 768px) {
        .chart-container {
            height: 250px;
        }
        .metric-value {
            font-size: 2rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Cabecera con información del profesor -->
    <div class="row mb-4">
        <div class="col-lg-4 mb-4 mb-lg-0">
            <div class="card professor-card h-100 border-0 shadow-sm">
                <div class="card-body text-center p-4">
                    <div class="avatar-container mb-3">
                        <i class="fas fa-user-circle fa-4x text-primary"></i>
                    </div>
                    <h4 class="mb-1">{{ profesor.nombre }} {{ profesor.apellido }}</h4>
                    {% if profesor.especialidad %}
                    <p class="text-muted mb-3"><i class="fas fa-dumbbell me-1"></i> {{ profesor.especialidad }}</p>
                    {% endif %}
                    <div class="d-flex justify-content-center mb-3">
                        <span class="badge bg-primary rounded-pill px-3 py-2">
                            <i class="fas fa-calendar-check me-1"></i> {{ metricas.total_clases }} clases
                        </span>
                    </div>
                    <hr>
                    <div class="text-start">
                        {% if profesor.email %}
                        <div class="mb-2">
                            <i class="fas fa-envelope text-muted me-2"></i> {{ profesor.email }}
                        </div>
                        {% endif %}
                        {% if profesor.telefono %}
                        <div class="mb-2">
                            <i class="fas fa-phone text-muted me-2"></i> {{ profesor.telefono }}
                        </div>
                        {% endif %}
                        {% if profesor.fecha_inicio %}
                        <div class="mb-2">
                            <i class="fas fa-calendar-alt text-muted me-2"></i> Desde: {{ profesor.fecha_inicio.strftime('%d/%m/%Y') }}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="m-0"><i class="fas fa-chart-pie me-2 text-primary"></i>Resumen de Rendimiento</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6 col-lg-3">
                            <div class="card metrics-card border-0 shadow-sm h-100">
                                <div class="card-body text-center p-3">
                                    <p class="metric-title">Clases Impartidas</p>
                                    <h2 class="metric-value text-primary mb-0">{{ metricas.total_clases }}</h2>
                                </div>
                                <div class="card-footer bg-primary text-white p-1 text-center">
                                    <small><i class="fas fa-calendar-alt me-1"></i>Total</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 col-lg-3">
                            <div class="card metrics-card border-0 shadow-sm h-100">
                                <div class="card-body text-center p-3">
                                    <p class="metric-title">Alumnos Totales</p>
                                    <h2 class="metric-value text-success mb-0">{{ metricas.total_alumnos }}</h2>
                                </div>
                                <div class="card-footer bg-success text-white p-1 text-center">
                                    <small><i class="fas fa-users me-1"></i>Participantes</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 col-lg-3">
                            <div class="card metrics-card border-0 shadow-sm h-100">
                                <div class="card-body text-center p-3">
                                    <p class="metric-title">Puntualidad</p>
                                    <h2 class="metric-value text-info mb-0">
                                        {% if metricas.puntualidad and metricas.puntualidad.total > 0 %}
                                            {{ (metricas.puntualidad.tasa)|round(1) }}%
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </h2>
                                </div>
                                <div class="card-footer bg-info text-white p-1 text-center">
                                    <small><i class="fas fa-clock me-1"></i>A tiempo</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 col-lg-3">
                            <div class="card metrics-card border-0 shadow-sm h-100">
                                <div class="card-body text-center p-3">
                                    <p class="metric-title">Variedad de Clases</p>
                                    <h2 class="metric-value text-warning mb-0">
                                        {% if metricas.variedad_clases is defined %}
                                            {{ metricas.variedad_clases|round(1) }}%
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </h2>
                                </div>
                                <div class="card-footer bg-warning text-white p-1 text-center">
                                    <small><i class="fas fa-random me-1"></i>Diversidad</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    {% if debug_mode %}
    <!-- Panel de depuración -->
    <div class="card mb-4 border-danger">
        <div class="card-header bg-danger text-white">
            <h5 class="mb-0 d-flex align-items-center">
                <i class="fas fa-bug me-2"></i>
                Depuración de Métricas
            </h5>
        </div>
        <div class="card-body">
            <div class="accordion" id="accordionDebug">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingOne">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                            Métricas Generales
                        </button>
                    </h2>
                    <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#accordionDebug">
                        <div class="accordion-body">
                            <pre class="bg-light p-3 rounded">{{ metricas|tojson(indent=2) }}</pre>
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingTwo">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                            Puntualidad
                        </button>
                    </h2>
                    <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#accordionDebug">
                        <div class="accordion-body">
                            <pre class="bg-light p-3 rounded">{{ metricas.puntualidad|tojson(indent=2) if metricas.puntualidad is defined else 'No disponible' }}</pre>
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingThree">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                            Distribución
                        </button>
                    </h2>
                    <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#accordionDebug">
                        <div class="accordion-body">
                            <pre class="bg-light p-3 rounded">{{ metricas.distribucion|tojson(indent=2) if metricas.distribucion is defined else 'No disponible' }}</pre>
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingFour">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
                            Tendencias
                        </button>
                    </h2>
                    <div id="collapseFour" class="accordion-collapse collapse" aria-labelledby="headingFour" data-bs-parent="#accordionDebug">
                        <div class="accordion-body">
                            <pre class="bg-light p-3 rounded">{{ metricas.tendencias|tojson(indent=2) if metricas.tendencias is defined else 'No disponible' }}</pre>
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingFive">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFive" aria-expanded="false" aria-controls="collapseFive">
                            Datos por Tipo
                        </button>
                    </h2>
                    <div id="collapseFive" class="accordion-collapse collapse" aria-labelledby="headingFive" data-bs-parent="#accordionDebug">
                        <div class="accordion-body">
                            <pre class="bg-light p-3 rounded">{{ metricas.datos_por_tipo|tojson(indent=2) if metricas.datos_por_tipo is defined else 'No disponible' }}</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Sección de gráficos principales -->
    <div class="row mb-4">
        <!-- Distribución por tipo de clase -->
        <div class="col-lg-4 mb-4 mb-lg-0">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3">
                    <h5 class="m-0"><i class="fas fa-chart-pie me-2 text-primary"></i>Distribución por Tipo de Clase</h5>
                </div>
                <div class="card-body">
                    {% if metricas.distribucion and metricas.distribucion.tipos %}
                        <div class="chart-container">
                            <canvas id="tipoClaseChart"></canvas>
                        </div>
                    {% else %}
                        <div class="alert alert-info d-flex align-items-center">
                            <i class="fas fa-info-circle me-2 fs-4"></i>
                            <div>No hay datos suficientes para mostrar la distribución por tipo de clase.</div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Evolución Mensual -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3">
                    <h5 class="m-0"><i class="fas fa-chart-line me-2 text-primary"></i>Evolución Mensual</h5>
                </div>
                <div class="card-body">
                    {% if metricas.datos_mensuales and metricas.datos_mensuales|length > 0 %}
                        <div class="chart-container" style="height: 350px;">
                            <canvas id="evolucionMensualChart"></canvas>
                        </div>
                    {% else %}
                        <div class="alert alert-info d-flex align-items-center">
                            <i class="fas fa-info-circle me-2 fs-4"></i>
                            <div>No hay datos suficientes para mostrar la evolución mensual.</div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Detalles por tipo de clase -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white py-3">
                    <h5 class="m-0"><i class="fas fa-th-list me-2 text-primary"></i>Análisis por Tipo de Clase</h5>
                </div>
                <div class="card-body">
                    {% if metricas.datos_por_tipo and metricas.datos_por_tipo|length > 0 %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th class="fw-semibold">Tipo</th>
                                        <th class="fw-semibold">Total Clases</th>
                                        <th class="fw-semibold">Promedio Alumnos</th>
                                        <th class="fw-semibold">Puntualidad</th>
                                        <th class="fw-semibold">Tendencia</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for tipo, datos in metricas.datos_por_tipo.items() %}
                                    <tr>
                                        <td>
                                            <span class="badge bg-secondary px-3 py-2 fw-normal">{{ tipo }}</span>
                                        </td>
                                        <td>{{ datos.total_clases }}</td>
                                        <td>{{ datos.promedio_alumnos|round(1) }}</td>
                                        <td>
                                            <div class="progress" style="height: 8px;">
                                                <div class="progress-bar bg-info" role="progressbar" 
                                                    style="width: {{ datos.tasa_puntualidad }}%;" 
                                                    aria-valuenow="{{ datos.tasa_puntualidad|round(1) }}" 
                                                    aria-valuemin="0" aria-valuemax="100">
                                                </div>
                                            </div>
                                            <small class="mt-1 d-block text-end">{{ datos.tasa_puntualidad|round(1) }}%</small>
                                        </td>
                                        <td>
                                            {% if datos.tendencia > 0 %}
                                                <span class="text-success"><i class="fas fa-arrow-up"></i> {{ datos.tendencia|round(1) }}%</span>
                                            {% elif datos.tendencia < 0 %}
                                                <span class="text-danger"><i class="fas fa-arrow-down"></i> {{ datos.tendencia|round(1) }}%</span>
                                            {% else %}
                                                <span class="text-muted"><i class="fas fa-equals"></i> 0%</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info d-flex align-items-center">
                            <i class="fas fa-info-circle me-2 fs-4"></i>
                            <div>No hay datos suficientes para mostrar el análisis por tipo de clase.</div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Análisis de puntualidad -->
    <div class="row mb-4">
        <div class="col-lg-6 mb-4 mb-lg-0">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3">
                    <h5 class="m-0"><i class="fas fa-chart-bar me-2 text-primary"></i>Análisis de Puntualidad</h5>
                </div>
                <div class="card-body">
                    {% if metricas.puntualidad and metricas.puntualidad.total > 0 %}
                        <div class="row">
                            <div class="col-md-6 mb-3 mb-md-0">
                                <div class="chart-container" style="height: 220px;">
                                    <canvas id="puntualidadChart"></canvas>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card border-0 bg-light">
                                    <div class="card-body p-3">
                                        <h6 class="text-center mb-3 fw-semibold">Detalle de Puntualidad</h6>
                                        <ul class="list-group list-group-flush">
                                            <li class="list-group-item border-0 bg-transparent d-flex justify-content-between align-items-center px-0">
                                                <span><i class="fas fa-check-circle text-success me-2"></i>Clases puntuales</span>
                                                <span class="badge bg-success rounded-pill">{{ metricas.puntualidad.puntual }}</span>
                                            </li>
                                            <li class="list-group-item border-0 bg-transparent d-flex justify-content-between align-items-center px-0">
                                                <span><i class="fas fa-exclamation-circle text-warning me-2"></i>Retrasos leves</span>
                                                <span class="badge bg-warning rounded-pill">{{ metricas.puntualidad.retraso_leve }}</span>
                                            </li>
                                            <li class="list-group-item border-0 bg-transparent d-flex justify-content-between align-items-center px-0">
                                                <span><i class="fas fa-times-circle text-danger me-2"></i>Retrasos significativos</span>
                                                <span class="badge bg-danger rounded-pill">{{ metricas.puntualidad.retraso_significativo }}</span>
                                            </li>
                                            <li class="list-group-item border-0 bg-transparent d-flex justify-content-between align-items-center px-0">
                                                <span class="fw-semibold"><i class="fas fa-clipboard-list text-primary me-2"></i>Total</span>
                                                <span class="badge bg-primary rounded-pill">{{ metricas.puntualidad.total }}</span>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="alert alert-info d-flex align-items-center">
                            <i class="fas fa-info-circle me-2 fs-4"></i>
                            <div>No hay datos suficientes para mostrar el análisis de puntualidad.</div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Incluir Chart.js y plugin datalabels -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

<!-- Scripts específicos para gráficos -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Registrar el plugin datalabels globalmente
    Chart.register(ChartDataLabels);
    
    // Definir colores para los gráficos
    const colors = {
        primary: {
            main: 'rgba(25, 118, 210, 1)',
            light: 'rgba(25, 118, 210, 0.7)'
        },
        success: {
            main: 'rgba(56, 142, 60, 1)',
            light: 'rgba(56, 142, 60, 0.7)'
        },
        warning: {
            main: 'rgba(245, 124, 0, 1)',
            light: 'rgba(245, 124, 0, 0.7)'
        },
        danger: {
            main: 'rgba(229, 57, 53, 1)',
            light: 'rgba(229, 57, 53, 0.7)'
        },
        info: {
            main: 'rgba(2, 136, 209, 1)',
            light: 'rgba(2, 136, 209, 0.7)'
        }
    };

    // Verificar si Chart.js está disponible
    if (typeof Chart === 'undefined') {
        console.error('Chart.js no está disponible. Asegúrate de incluir la biblioteca.');
        
        // Mostrar mensaje de error en los contenedores de gráficos
        const errorMessage = '<div class="alert alert-danger">No se pueden cargar los gráficos: Chart.js no está disponible.</div>';
        document.querySelectorAll('.chart-container').forEach(container => {
            container.style.display = 'none';
            container.insertAdjacentHTML('afterend', errorMessage);
        });
        return;
    }

    // Configuración global de Chart.js
    Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif';
    Chart.defaults.font.size = 12;
    Chart.defaults.color = '#6c757d';
    Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(33, 37, 41, 0.9)';
    Chart.defaults.plugins.tooltip.padding = 10;
    Chart.defaults.plugins.tooltip.cornerRadius = 4;
    Chart.defaults.plugins.tooltip.titleFont = { size: 14, weight: 'bold' };
    
    {% if metricas.distribucion and metricas.distribucion.tipos %}
    try {
        // Gráfico de tipos de clase
        const tiposClases = {{ metricas.distribucion.tipos|tojson }};
        const porcentajesTipos = {{ metricas.distribucion.porcentajes|tojson }};
        
        // Preparar colores para cada tipo de clase
        const backgroundColors = [
            colors.primary.light,
            colors.success.light,
            colors.warning.light,
            colors.danger.light,
            colors.info.light
        ];
        
        const ctxTipos = document.getElementById('tipoClaseChart').getContext('2d');
        // Preparar etiquetas con porcentajes
        const labelsWithPercentages = Object.keys(tiposClases).map(tipo => {
            const percentage = porcentajesTipos[tipo] || 0;
            return `${tipo}: ${percentage.toFixed(1)}%`;
        });

        new Chart(ctxTipos, {
            type: 'doughnut',
            data: {
                labels: labelsWithPercentages,
                datasets: [{
                    data: Object.values(tiposClases),
                    backgroundColor: backgroundColors,
                    borderWidth: 0,
                    borderRadius: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '65%',
                plugins: {
                    legend: {
                        position: 'right',
                        align: 'center',
                        labels: {
                            boxWidth: 15,
                            padding: 15,
                            usePointStyle: true,
                            pointStyle: 'circle'
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.raw || 0;
                                const index = context.dataIndex;
                                const originalLabel = Object.keys(tiposClases)[index];
                                const percentage = porcentajesTipos[originalLabel] || 0;
                                return `${value} clases (${percentage.toFixed(1)}%)`;
                            }
                        }
                    },
                    // Plugin personalizado para mostrar los porcentajes en el gráfico
                    datalabels: {
                        color: '#fff',
                        font: {
                            weight: 'bold',
                            size: 11
                        },
                        formatter: function(value, context) {
                            const index = context.dataIndex;
                            const originalLabel = Object.keys(tiposClases)[index];
                            const percentage = porcentajesTipos[originalLabel] || 0;
                            return `${percentage.toFixed(1)}%`;
                        },
                        anchor: 'center',
                        align: 'center',
                        offset: 0
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error al generar gráfico de tipos de clase:', error);
        document.getElementById('tipoClaseChart').closest('.chart-container').insertAdjacentHTML('afterend', 
            `<div class="alert alert-danger">Error al generar el gráfico: ${error.message}</div>`);
    }
    {% endif %}

    {% if metricas.datos_mensuales and metricas.datos_mensuales|length > 0 %}
    try {
        // Gráfico de evolución mensual
        const datosMensuales = {{ metricas.datos_mensuales|tojson }};
        const ctxEvolucion = document.getElementById('evolucionMensualChart').getContext('2d');
        const etiquetasMeses = datosMensuales.map(d => d.etiqueta);
        const datosAlumnos = datosMensuales.map(d => d.promedio_alumnos);
        const datosPuntualidad = datosMensuales.map(d => d.puntualidad);

        // Función para crear un degradado
        function createGradient(ctx, color) {
            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, color.replace('1)', '0.3)'));
            gradient.addColorStop(1, color.replace('1)', '0.0)'));
            return gradient;
        }

        new Chart(ctxEvolucion, {
            type: 'line',
            data: {
                labels: etiquetasMeses,
                datasets: [
                    {
                        label: 'Promedio Alumnos',
                        data: datosAlumnos,
                        borderColor: colors.primary.main,
                        backgroundColor: createGradient(ctxEvolucion, colors.primary.main),
                        tension: 0.4,
                        fill: true,
                        yAxisID: 'y',
                        borderWidth: 2,
                        pointRadius: 3,
                        pointBackgroundColor: 'white',
                        pointBorderColor: colors.primary.main,
                        pointBorderWidth: 2,
                        datalabels: {
                            align: 'end',
                            anchor: 'end',
                            backgroundColor: colors.primary.main,
                            borderRadius: 4,
                            color: 'white',
                            padding: 4,
                            formatter: function(value) {
                                return value.toFixed(1);
                            }
                        }
                    },
                    {
                        label: 'Puntualidad (%)',
                        data: datosPuntualidad,
                        borderColor: colors.success.main,
                        backgroundColor: createGradient(ctxEvolucion, colors.success.main),
                        tension: 0.4,
                        fill: true,
                        yAxisID: 'y1',
                        borderWidth: 2,
                        pointRadius: 3,
                        pointBackgroundColor: 'white',
                        pointBorderColor: colors.success.main,
                        pointBorderWidth: 2,
                        datalabels: {
                            align: 'start',
                            anchor: 'start',
                            backgroundColor: colors.success.main,
                            borderRadius: 4,
                            color: 'white',
                            padding: 4,
                            formatter: function(value) {
                                return value.toFixed(1) + '%';
                            }
                        }
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: {
                        position: 'top',
                        align: 'end',
                        labels: {
                            boxWidth: 12,
                            usePointStyle: true,
                            pointStyle: 'rectRounded'
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    },
                    // Configuración global para datalabels en el gráfico de línea
                    datalabels: {
                        display: function(context) {
                            // Solo mostrar etiquetas en puntos específicos para evitar sobrecarga
                            return context.dataIndex % 2 === 0;
                        },
                        font: {
                            weight: 'bold',
                            size: 10
                        },
                        color: '#fff',
                        textStrokeColor: 'rgba(0, 0, 0, 0.5)',
                        textStrokeWidth: 1,
                        offset: 8,
                        padding: {
                            top: 4,
                            bottom: 4,
                            left: 6,
                            right: 6
                        },
                        borderRadius: 4
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Promedio Alumnos'
                        },
                        grid: {
                            color: 'rgba(0,0,0,0.05)'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Puntualidad (%)'
                        },
                        grid: {
                            drawOnChartArea: false
                        },
                        min: 0,
                        max: 100
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error al generar gráfico de evolución mensual:', error);
        document.getElementById('evolucionMensualChart').closest('.chart-container').insertAdjacentHTML('afterend', 
            `<div class="alert alert-danger">Error al generar el gráfico: ${error.message}</div>`);
    }
    {% endif %}

    {% if metricas.puntualidad and metricas.puntualidad.total > 0 %}
    try {
        // Gráfico de puntualidad
        const puntualidadData = {
            labels: ['Puntual', 'Retraso Leve', 'Retraso Significativo'],
            data: [
                {{ metricas.puntualidad.puntual }},
                {{ metricas.puntualidad.retraso_leve }},
                {{ metricas.puntualidad.retraso_significativo }}
            ]
        };
        
        // Calcular porcentajes para puntualidad
        const totalPuntualidad = puntualidadData.data.reduce((acc, val) => acc + val, 0);
        const porcentajesPuntualidad = puntualidadData.data.map(val => 
            totalPuntualidad > 0 ? (val / totalPuntualidad * 100).toFixed(1) : 0
        );
        
        // Preparar etiquetas con porcentajes
        const puntualidadLabelsWithPercentages = puntualidadData.labels.map((label, i) => 
            `${label}: ${porcentajesPuntualidad[i]}%`
        );
        
        const ctxPuntualidad = document.getElementById('puntualidadChart').getContext('2d');
        new Chart(ctxPuntualidad, {
            type: 'pie',
            data: {
                labels: puntualidadLabelsWithPercentages,
                datasets: [{
                    data: puntualidadData.data,
                    backgroundColor: [
                        colors.success.light,
                        colors.warning.light,
                        colors.danger.light
                    ],
                    borderWidth: 0,
                    borderRadius: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            boxWidth: 12,
                            padding: 15,
                            usePointStyle: true,
                            pointStyle: 'circle'
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.raw || 0;
                                const percentage = porcentajesPuntualidad[context.dataIndex];
                                return `${value} clases (${percentage}%)`;
                            }
                        }
                    },
                    // Plugin para mostrar los porcentajes en el gráfico
                    datalabels: {
                        color: '#fff',
                        font: {
                            weight: 'bold',
                            size: 12
                        },
                        formatter: function(value, context) {
                            return porcentajesPuntualidad[context.dataIndex] + '%';
                        },
                        anchor: 'center',
                        align: 'center',
                        offset: 0
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error al generar gráfico de puntualidad:', error);
        document.getElementById('puntualidadChart').closest('.chart-container').insertAdjacentHTML('afterend', 
            `<div class="alert alert-danger">Error al generar el gráfico: ${error.message}</div>`);
    }
    {% endif %}

    // Active los tooltips de Bootstrap
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Código de manejo de cálculo de tendencias eliminado
    
    // Si estamos en modo debug, expandir automáticamente los paneles de depuración
    {% if debug_mode %}
    // Expandir el primer panel del acordeón de depuración
    const firstAccordionButton = document.querySelector('#accordionDebug .accordion-button');
    const firstAccordionCollapse = document.querySelector('#accordionDebug .accordion-collapse');
    if (firstAccordionButton && firstAccordionCollapse) {
        firstAccordionButton.classList.remove('collapsed');
        firstAccordionButton.setAttribute('aria-expanded', 'true');
        firstAccordionCollapse.classList.add('show');
    }
    {% endif %}
    
    // Añadir botón de modo depuración en la esquina superior derecha
    const addDebugToggle = () => {
        const container = document.querySelector('.container');
        if (!container) return;
        
        const currentUrl = new URL(window.location.href);
        const hasDebug = currentUrl.searchParams.has('debug');
        
        const debugButton = document.createElement('div');
        debugButton.className = 'position-fixed top-0 end-0 m-3';
        debugButton.innerHTML = `
            <a href="${hasDebug ? currentUrl.pathname : currentUrl.pathname + '?debug=true'}" 
               class="btn btn-sm ${hasDebug ? 'btn-danger' : 'btn-secondary'} shadow-sm">
                <i class="fas fa-bug me-1"></i>${hasDebug ? 'Desactivar Depuración' : 'Modo Depuración'}
            </a>
        `;
        
        container.appendChild(debugButton);
    };
    
    addDebugToggle();
});
</script>
{% endblock %}